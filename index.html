<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“š é›²æ•™å®¤å‚™èª²è³‡æ–™ v1.6.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // è¨­å®š PDF.js worker çš„è·¯å¾‘
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
    </script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        [disabled] { opacity: 0.4; cursor: not-allowed; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .modal.hidden { visibility: hidden; opacity: 0; }
        .modal.visible { visibility: visible; opacity: 1; }
        .modal.visible .modal-content { transform: translateY(0); }
        .modal.hidden .modal-content { transform: translateY(-20px); }
        .nav-button {
            @apply w-full text-left px-5 py-4 bg-white shadow rounded-lg border border-gray-200 transition-all duration-200 ease-in-out;
            @apply hover:bg-blue-50 hover:shadow-md hover:border-blue-300;
        }
        .nav-button-disabled {
            @apply w-full text-left px-5 py-4 bg-gray-100 shadow-inner rounded-lg border border-gray-200 text-gray-400;
        }
        
        /* ... (æ—¥èªŒæ¨£å¼) ... */
        #batchLog p { @apply py-1 px-2 border-b border-gray-100; }
        #batchLog p.error { @apply bg-red-100 text-red-700; }
        #batchLog p.success { @apply bg-green-50 text-green-700; }
        #batchLog p.info { @apply text-blue-700 font-semibold; }
        
        #file-upload-input {
            @apply block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none;
            @apply file:bg-indigo-600 file:text-white file:font-semibold file:border-0 file:py-2 file:px-4 file:mr-4 file:cursor-pointer;
        }
        
        /* ğŸ¨ v1.5.8 æ–°å¢ (éœ€æ±‚ 2)ï¼šAI é è¦½æ–¹æ ¼æ¨£å¼ */
        .ai-preview-box {
            @apply bg-white p-4 rounded-lg border border-gray-300 shadow-sm grid grid-cols-1 md:grid-cols-4 gap-3;
        }
        .ai-preview-box label {
            @apply block text-xs font-medium text-gray-500 mb-1;
        }
        .ai-preview-box input, .ai-preview-box textarea {
            @apply w-full p-2 border rounded-md text-sm font-mono bg-gray-50;
        }
        .ai-preview-box .content-area {
            @apply md:col-span-4;
        }
    </style>
</head>
<body class="bg-gray-50 pt-20">

    <header class="fixed top-0 left-0 w-full bg-white shadow-md z-30">
        <div class="container mx-auto max-w-5xl flex justify-between items-center p-4">
            <h1 class="text-2xl font-bold text-blue-700">ğŸ“š é›²æ•™å®¤å‚™èª²è³‡æ–™ v1.6.0</h1>
            
            <div class="flex items-center gap-2">
                 <button id="settingsBtn" title="ç™»å…¥ç®¡ç†" class="text-3xl hover:text-blue-600 transition-transform duration-200 hover:rotate-12">
                    âš™ï¸
                </button>
                 <button id="logoutBtn" title="ç™»å‡ºç®¡ç†" class="text-3xl hover:text-red-500 transition-all hidden">
                    ğŸ”“
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-5xl p-4">
        <div id="breadcrumb" class="mb-4 text-gray-500 font-semibold">
            </div>
        <div id="navigator" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            </div>
        <div id="loading" class="text-center p-10 text-gray-500 hidden">
            <p>ğŸ”„ æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</p>
        </div>
        <div id="content-display-area" class="hidden mt-6">
             <div class="bg-white p-6 rounded-xl shadow-lg border">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="content-title" class="text-xl font-bold text-gray-800"></h3>
                    <button id="copy-content-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-all">
                        ğŸ“‹ è¤‡è£½å…§å®¹
                    </button>
                </div>
                <textarea id="content-textarea" readonly class="w-full h-64 p-4 bg-gray-100 border rounded-md font-mono text-sm"></textarea>
            </div>
        </div>
    </main>

    <div id="adminModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4">
        <div class="modal-content bg-gray-50 rounded-2xl shadow-xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col">
            <header class="p-5 border-b bg-white rounded-t-2xl flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ” æ•™æç®¡ç†å¾Œå° (v1.6.0)</h2>
                <button id="closeAdminBtn" class="text-3xl text-gray-500 hover:text-red-500">&times;</button>
            </header>
            
            <div id="adminForm" class="p-6 flex-grow overflow-y-auto">

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="space-y-6">
                        
                        <section class="bg-yellow-50 p-5 rounded-lg border-2 border-yellow-200 shadow-sm">
                            <h3 class="text-lg font-semibold text-yellow-800 mb-3">ğŸ¤– AI åŠ©ç†åŠŸèƒ½è¨­å®š</h3>
                            <p class="text-sm text-gray-700 mb-2">
                                AI ç”ŸæˆåŠŸèƒ½éœ€è¦æ‚¨è‡ªå·±çš„ Google AI API é‡‘é‘°ã€‚ 
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline font-medium">é»æ­¤å…è²»å–å¾—é‡‘é‘°</a>ï¼Œ
                                è¨­å®šå°‡å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒå¤–æ´©ã€‚
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <div class="md:col-span-2">
                                     <label for="googleAiApiKey" class="block text-xs font-medium text-gray-600 mb-1">Google AI API é‡‘é‘°</label>
                                    <input type="password" id="googleAiApiKey" class="w-full p-2 border rounded-md" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Google AI API é‡‘é‘°...">
                                </div>
                                 <div>
                                    <label for="googleAiModelName" class="block text-xs font-medium text-gray-600 mb-1">AI æ¨¡å‹åç¨±</label>
                                    <input type="text" id="googleAiModelName" class="w-full p-2 border rounded-md" value="gemini-1.5-flash-latest">
                                </div>
                            </div>
                            <button id="saveAiSettingsBtn" type="button" class="mt-3 px-5 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-md shadow flex-shrink-0">
                                å„²å­˜è¨­å®š
                            </button>
                            <p id="aiSettingsStatus" class="text-xs text-gray-500 mt-2"></p>
                        </section>
                        
                        <section class="bg-indigo-50 p-5 rounded-lg border-2 border-indigo-200 shadow-sm">
                            <h3 class="text-lg font-semibold text-indigo-800 mb-3">ğŸ§  AI è³‡æ–™è§£æ (æ‰¹æ¬¡åŒ¯å…¥) (v1.5.9)</h3>
                            
                            <p class="text-sm text-gray-700 mb-2">
                                æ­¥é©Ÿ 1ï¼šä¸Šå‚³ `.txt` æˆ– `.pdf` æª”æ¡ˆã€‚
                            </p>
                            <input id="file-upload-input" type="file" accept=".txt,.pdf" class="mb-4">

                            <p class="text-sm text-gray-700 mb-2">
                                æ­¥é©Ÿ 2ï¼šé¸æ“‡è¦ä½¿ç”¨çš„ã€Œåˆ†ææ¨¡å¼ã€ã€‚
                            </p>
                            <select id="analysisMode" class="w-full p-2 border rounded-md mb-4 bg-white">
                                <option value="ai_shengzi">ğŸ“ AI - ç”Ÿå­— (å–®è¡Œå¯†é›†å‹)</option>
                                <option value="ai_lesson_text">ğŸ“– AI - èª²æ–‡ (å¤šæ®µè½é•·æ–‡ä»¶)</option>
                                <option value="ai_terms">ğŸ—£ï¸ AI - èªè© (ç‰¹å®šå€å¡Šæ“·å–)</option>
                                <option value="ai_patterns">ğŸ§© AI - å¥å‹/çŸ­èª/é€ å¥ (ä»¿ v2.4.1 é‚è¼¯)</option>
                            </select>

                            <p class="text-sm text-gray-700 mb-2">
                                æ­¥é©Ÿ 3ï¼šç¢ºèªä¸‹æ–¹æ–‡å­—æ¡†çš„å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚
                            </p>
                            <textarea id="text-input-area" rows="10" class="w-full p-3 border rounded-md font-mono text-sm bg-white" placeholder="ä¸Šå‚³ .txt æˆ– .pdf æª”æ¡ˆå¾Œï¼Œè§£æå‡ºçš„æ–‡å­—å°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                            
                            <p class="text-sm text-gray-700 mt-4 mb-2">
                                æ­¥é©Ÿ 4ï¼š(é¸å¡«) åŠ å…¥é¡å¤–æŒ‡ä»¤ä»¥å„ªåŒ– AI çµæœã€‚
                            </p>
                            <input type="text" id="ai-extra-prompt" class="w-full p-2 border rounded-md bg-white mb-4" placeholder="ä¾‹å¦‚ï¼šè«‹åªæ“·å–æ¨™é¡Œç‚ºã€Œä¸€ã€ã€çš„å…§å®¹...">

                            <p class="text-sm text-gray-700 mb-2">
                                æ­¥é©Ÿ 5ï¼šé»æ“ŠæŒ‰éˆ•ï¼Œé–‹å§‹åˆ†æ (çµæœå°‡é¡¯ç¤ºæ–¼ä¸‹æ–¹)ã€‚
                            </p>
                            <button id="batchUploadBtn" type="button" class="w-full px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg rounded-lg shadow-lg transition-all transform hover:scale-105 disabled:bg-gray-400">
                                ğŸ”¬ é–‹å§‹åˆ†æ
                            </button>
                            
                            <div id="ai-preview-area" class="mt-4 hidden space-y-2">
                                <label for="ai-result-preview-dynamic" class="block text-sm font-medium text-gray-700">æ­¥é©Ÿ 6ï¼šç¢ºèª (æˆ–ç·¨è¼¯) AI åˆ†æçµæœ (æ¢åˆ—å¼æ–¹æ ¼)</label>
                                
                                <div id="ai-result-preview-dynamic" class="space-y-4 max-h-96 overflow-y-auto p-2 bg-indigo-100 rounded-md">
                                    </div>
                                
                                <textarea id="ai-result-preview" rows="12" class="w-full p-3 border rounded-md font-mono text-xs bg-gray-50 hidden" placeholder="AI åˆ†æçµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
                                
                                <button id="confirmBatchUploadBtn" type="button" class="w-full px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-lg shadow-lg transition-all transform hover:scale-105 disabled:bg-gray-400">
                                    ğŸš€ ç¢ºèªç„¡èª¤ï¼Œé–‹å§‹ä¸Šå‚³
                                </button>
                            </div>

                            <div id="batchLog" class="mt-4 p-3 bg-white rounded-md border border-gray-300 max-h-40 overflow-y-auto text-sm font-mono hidden">
                                <p>æº–å‚™é–‹å§‹æ‰¹æ¬¡è™•ç†...</p>
                            </div>
                        </section>
                    </div>

                    <div class="space-y-6">
                        
                        <section class="bg-white p-5 rounded-lg border shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">1. é¸æ“‡è¦ç·¨è¼¯çš„æ•™æ (æ‰‹å‹•) (v1.5.7 å„ªåŒ–)</h3>
                            
                            <p class="text-sm font-medium text-gray-500 mb-2">æ­¥é©Ÿ 1: é¸æ“‡åˆ†é¡</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 border rounded-md">
                                <div>
                                    <label for="adminPublisher" class="block text-xs font-medium text-gray-600 mb-1">ç‰ˆæœ¬</label>
                                    <select id="adminPublisher" class="w-full p-2 border rounded-md">
                                        <option value="Hanlin">ç¿°æ—</option>
                                        <option value="Nanyi">å—ä¸€</option>
                                        <option value="Kangxuan">åº·è»’</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="adminSubject" class="block text-xs font-medium text-gray-600 mb-1">ç§‘ç›®</label>
                                    <select id="adminSubject" class="w-full p-2 border rounded-md">
                                        <option value="Chinese">åœ‹èª</option>
                                        <option value="Math">æ•¸å­¸</option>
                                        <option value="Science">è‡ªç„¶</option>
                                        <option value="Social">ç¤¾æœƒ</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="adminSemester" class="block text-xs font-medium text-gray-600 mb-1">å­¸æœŸ</label>
                                    <select id="adminSemester" class="w-full p-2 border rounded-md">
                                        <option value="S1">ä¸Šå­¸æœŸ</option>
                                        <option value="S2">ä¸‹å­¸æœŸ</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="adminGrade" class="block text-xs font-medium text-gray-600 mb-1">å¹´ç´š</label>
                                    <select id="adminGrade" class="w-full p-2 border rounded-md">
                                        <option value="G1">ä¸€å¹´ç´š</option>
                                        <option value="G2">äºŒå¹´ç´š</option>
                                        <option value="G3">ä¸‰å¹´ç´š</option>
                                        <option value="G4">å››å¹´ç´š</option>
                                        <option value="G5">äº”å¹´ç´š</option>
                                        <option value="G6">å…­å¹´ç´š</option>
                                    </select>
                                </div>
                            </div>
                            
                            <p class="text-sm font-medium text-gray-500 mb-2">æ­¥é©Ÿ 2: é¸æ“‡æˆ–æ–°å¢å–®å…ƒ</p>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button id="fetchUnitsBtn" type="button" class="flex-grow md:flex-grow-0 px-5 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-md shadow">
                                    ğŸ”„ åµæ¸¬æ­¤åˆ†é¡ä¸‹çš„ç¾æœ‰å–®å…ƒ
                                </button>
                                <button id="createNewUnitBtn" type="button" class="flex-grow md:flex-grow-0 px-5 py-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-md shadow">
                                    â• æ‰‹å‹•æ–°å¢å–®å…ƒ ID
                                </button>
                            </div>

                            <div id="unitInputContainer" class="mt-2">
                                <label for="adminUnitSelector" class="block text-sm font-medium text-gray-600 mb-1 hidden">é¸æ“‡å–®å…ƒ (v1.5.6)</label>
                                <select id="adminUnitSelector" class="w-full p-2 border rounded-md bg-gray-50 hidden">
                                    <option value="">-- è«‹å…ˆåµæ¸¬å–®å…ƒ --</option>
                                </select>
                                
                                <label for="adminUnitId" class="block text-sm font-medium text-gray-600 mb-1">å–®å…ƒ ID (è‡ªè¨‚) (v1.5.6)</label>
                                <input type="text" id="adminUnitId" class="w-full p-2 border rounded-md" placeholder="ä¾‹å¦‚: L1 æˆ– 1-1 (å¯é»ä¸Šæ–¹æŒ‰éˆ•åµæ¸¬)">
                            </div>
                            <p id="adminDocIdPreview" class="text-xs text-blue-700 font-semibold mt-2">æç¤ºï¼šæ–‡ä»¶ ID å°‡ç”±ä»¥ä¸Š 5 å€‹æ¬„ä½çµ„åˆè€Œæˆ...</p>


                            <p class="text-sm font-medium text-gray-500 mb-2 mt-4">æ­¥é©Ÿ 3: è¼‰å…¥è³‡æ–™ (æˆ–åˆªé™¤)</p>
                            <div class="flex flex-wrap gap-2">
                                <button id="loadDataBtn" type="button" class="px-5 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded-md shadow">
                                    ğŸ“¥ è¼‰å…¥è³‡æ–™
                                </button>
                                <button id="deleteDocBtn" type="button" class="px-5 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md shadow">
                                    ğŸ—‘ï¸ åˆªé™¤æ­¤å–®å…ƒ
                                </button>
                            </div>
                        </section>
                        
                        <section class="bg-white p-5 rounded-lg border shadow-sm space-y-4">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">2. è¼¸å…¥æ•™æå…§å®¹ (æ‰‹å‹•è‡ªè¨‚æ¬„ä½)</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-50 p-4 rounded-md border">
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="adminLabel1" class="block text-sm font-medium text-gray-600">æ¬„ä½ 1 åç¨±</label>
                                        <button type="button" class="text-xs text-red-500 hover:text-red-700" data-clear-id="1">æ¸…ç©ºæ­¤æ¬„</button>
                                    </div>
                                    <input type="text" id="adminLabel1" class="w-full p-2 border rounded-md mb-2" placeholder="ä¾‹å¦‚: ç”Ÿå­—">
                                    <label for="adminContent1" class="block text-sm font-medium text-gray-600 mb-1">æ¬„ä½ 1 å…§å®¹ (æ¯è¡Œä¸€ç­†)</label>
                                    <textarea id="adminContent1" rows="5" class="w-full p-2 border rounded-md" placeholder="æ¬„ä½ 1 å…§å®¹..."></textarea>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-md border">
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="adminLabel2" class="block text-sm font-medium text-gray-600">æ¬„ä½ 2 åç¨±</label>
                                        <button type="button" class="text-xs text-red-500 hover:text-red-700" data-clear-id="2">æ¸…ç©ºæ­¤æ¬„</button>
                                    </div>
                                    <input type="text" id="adminLabel2" class="w-full p-2 border rounded-md mb-2" placeholder="ä¾‹å¦‚: èªè©">
                                    <label for="adminContent2" class="block text-sm font-medium text-gray-600 mb-1">æ¬„ä½ 2 å…§å®¹ (æ¯è¡Œä¸€ç­†)</label>
                                    <textarea id="adminContent2" rows="5" class="w-full p-2 border rounded-md" placeholder="æ¬„ä½ 2 å…§å®¹..."></textarea>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-md border">
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="adminLabel3" class="block text-sm font-medium text-gray-600">æ¬„ä½ 3 åç¨±</label>
                                        <button type="button" class="text-xs text-red-500 hover:text-red-700" data-clear-id="3">æ¸…ç©ºæ­¤æ¬„</button>
                                    </div>
                                    <input type="text" id="adminLabel3" class="w-full p-2 border rounded-md mb-2" placeholder="ä¾‹å¦‚: å¥å‹">
                                    <label for="adminContent3" class="block text-sm font-medium text-gray-600 mb-1">æ¬„ä½ 3 å…§å®¹ (æ¯è¡Œä¸€ç­†)</label>
                                    <textarea id="adminContent3" rows="5" class="w-full p-2 border rounded-md" placeholder="æ¬„ä½ 3 å…§å®¹..."></textarea>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-md border">
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="adminLabel4" class="block text-sm font-medium text-gray-600">æ¬„ä½ 4 åç¨±</label>
                                        <button type="button" class="text-xs text-red-500 hover:text-red-700" data-clear-id="4">æ¸…ç©ºæ­¤æ¬„</button>
                                    </div>
                                    <input type="text" id="adminLabel4" class="w-full p-2 border rounded-md mb-2" placeholder="ä¾‹å¦‚: é‡é»">
                                    <label for="adminContent4" class="block text-sm font-medium text-gray-600 mb-1">æ¬„ä½ 4 å…§å®¹ (æ¯è¡Œä¸€ç­†)</label>
                                    <textarea id="adminContent4" rows="5" class="w-full p-2 border rounded-md" placeholder="æ¬„ä½ 4 å…§å®¹..."></textarea>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-md border">
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="adminLabel5" class="block text-sm font-medium text-gray-600">æ¬„ä½ 5 åç¨±</label>
                                        <button type="button" class="text-xs text-red-500 hover:text-red-700" data-clear-id="5">æ¸…ç©ºæ­¤æ¬„</button>
                                    </div>
                                    <input type="text" id="adminLabel5" class="w-full p-2 border rounded-md mb-2" placeholder="æ¬„ä½ 5 (å¯ç•™ç™½)">
                                    <label for="adminContent5" class="block text-sm font-medium text-gray-600 mb-1">æ¬„ä½ 5 å…§å®¹ (æ¯è¡Œä¸€ç­†)</label>
                                    <textarea id="adminContent5" rows="5" class="w-full p-2 border rounded-md" placeholder="æ¬„ä½ 5 å…§å®¹ (å¯ç•™ç™½)"></textarea>
                                </div>
                            </div>
                            <hr class="my-4">
                            <div>
                                <label for="adminMainText" class="block text-sm font-medium text-gray-600 mb-1">ä¸»è¦å…§å®¹ (ä¾‹å¦‚: èª²æ–‡)</label>
                                <textarea id="adminMainText" rows="10" class="w-full p-3 border rounded-md" placeholder="åœ¨æ­¤è²¼ä¸Šå®Œæ•´èª²æ–‡æˆ–ä¸»è¦èªªæ˜..."></textarea>
                            </div>
                        </section>
                    </div>

                </div> </div>
            
            <footer class="p-5 border-t bg-white rounded-b-2xl">
                <button id="saveDataBtn" type="button" class="w-full md:w-auto px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-lg shadow-lg transition-all transform hover:scale-105">
                    â˜ï¸ å„²å­˜ (æ‰‹å‹•)
                </button>
            </footer>
        </div>
    </div>

    <div id="toast" class="fixed top-24 right-6 bg-blue-600 text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform translate-x-full opacity-0 z-50">
        <span id="toast-message"></span>
    </div>

<script>
    // âš ï¸âš ï¸âš ï¸ é—œéµæ­¥é©Ÿ (v1.5.1) âš ï¸âš ï¸âš ï¸
    // éŒ¯èª¤ 1 & 2 ä¿®æ­£é»ï¼š
    // è«‹å°‡æ‚¨åœ¨ Firebase ä¸»æ§å°å–å¾—çš„ firebaseConfig ç‰©ä»¶ï¼Œå®Œæ•´è²¼åˆ°ä¸‹æ–¹å–ä»£ã€‚
    // é€™æ˜¯é€ æˆ `Could not reach Cloud Firestore backend` çš„ä¸»å› ã€‚
  const firebaseConfig = {
      apiKey: "AIzaSyB2TJo3c88XGE-f4JcmB5w5mCmN4FnJsQI",
      authDomain: "myclass26005-date.firebaseapp.com",
      projectId: "myclass26005-date",
      storageBucket: "myclass26005-date.firebasestorage.app",
      messagingSenderId: "770187631415",
      appId: "1:770187631415:web:cb40769d4ed1c4a1ae98b2"
};


    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- åƒæ•¸è¨­å®š ---
    const CURRICULUM_COLLECTION = "curriculums"; 
    
    // ğŸ¨ v1.5.7 æç¤ºï¼šç®¡ç†å¾Œå°å¯†ç¢¼ (å¯åœ¨æ­¤ä¿®æ”¹)
    const ADMIN_PASSWORD = "26005"; 
    // ğŸ¨ v1.6.0 ä¿®æ­£ (éœ€æ±‚ 1)ï¼šæ›´æ–°ç™»å…¥ç‹€æ…‹çš„ Session Key
    const ADMIN_AUTH_KEY = "isAdminAuth_v1.6.0";

    const HIERARCHY = [
        { level: 0, title: "é¸æ“‡ç‰ˆæœ¬", options: [{ label: "ç¿°æ—", key: "Hanlin" }, { label: "å—ä¸€", key: "Nanyi" }, { label: "åº·è»’", key: "Kangxuan" }] },
        { level: 1, title: "é¸æ“‡ç§‘ç›®", options: [{ label: "åœ‹èª", key: "Chinese" }, { label: "æ•¸å­¸", key: "Math" }, { label: "è‡ªç„¶", key: "Science" }, { label: "ç¤¾æœƒ", key: "Social" }] },
        { level: 2, title: "é¸æ“‡å­¸æœŸ", options: [{ label: "ä¸Šå­¸æœŸ", key: "S1" }, { label: "ä¸‹å­¸æœŸ", key: "S2" }] },
        { level: 3, title: "é¸æ“‡å¹´ç´š", options: [{ label: "ä¸€å¹´ç´š", key: "G1" }, { label: "äºŒå¹´ç´š", key: "G2" }, { label: "ä¸‰å¹´ç´š", key: "G3" }, { label: "å››å¹´ç´š", key: "G4" }, { label: "äº”å¹´ç´š", key: "G5" }, { label: "å…­å¹´ç´š", key: "G6" }] }
    ];
        
    // --- å…¨åŸŸè®Šæ•¸ ---
    let existingPaths = new Set(); 
    let currentPathParts = []; 
    let currentLabels = []; 
    let currentDocCache = {}; 

    // --- DOM å…ƒç´  ---
    const dom = {
        navigator: document.getElementById("navigator"),
        breadcrumb: document.getElementById("breadcrumb"),
        loading: document.getElementById("loading"),
        adminModal: document.getElementById("adminModal"),
        contentArea: document.getElementById("content-display-area"),
        contentTitle: document.getElementById("content-title"),
        contentTextArea: document.getElementById("content-textarea"),
        copyContentBtn: document.getElementById("copy-content-btn"),
        toast: document.getElementById("toast"),
        toastMessage: document.getElementById("toast-message"),
        settingsBtn: document.getElementById("settingsBtn"), // ğŸ¨ v1.5.8 (éœ€æ±‚ 1)
        logoutBtn: document.getElementById("logoutBtn"),     // ğŸ¨ v1.5.9 (éœ€æ±‚ 2)
        
        // æ‰¹æ¬¡è™•ç† DOM
        fileUploadInput: document.getElementById("file-upload-input"),
        textInputArea: document.getElementById("text-input-area"),
        batchUploadBtn: document.getElementById("batchUploadBtn"),
        batchLog: document.getElementById("batchLog"),
        analysisMode: document.getElementById("analysisMode"),
        aiExtraPrompt: document.getElementById("ai-extra-prompt"), // ğŸ¨ v1.5.9 (éœ€æ±‚ 3)
        
        // ğŸ¨ v1.5.8 ä¿®æ­£ (éœ€æ±‚ 2)ï¼šAI é è¦½å€
        aiPreviewArea: document.getElementById("ai-preview-area"),
        aiResultPreview: document.getElementById("ai-result-preview"), // èˆŠçš„ (é¡¯ç¤ºéŒ¯èª¤)
        aiResultPreviewDynamic: document.getElementById("ai-result-preview-dynamic"), // æ–°çš„ (æ–¹æ ¼)
        confirmBatchUploadBtn: document.getElementById("confirmBatchUploadBtn")
    };
    
    // --- ğŸ¨ v1.5.0 æ–°å¢ï¼šAI API é‡‘é‘°ç®¡ç† DOM ---
    const dom_v1_5 = {
        apiKeyInput: document.getElementById("googleAiApiKey"),
        apiModelInput: document.getElementById("googleAiModelName"),
        saveAiSettingsBtn: document.getElementById("saveAiSettingsBtn"),
        aiSettingsStatus: document.getElementById("aiSettingsStatus")
    };
    const API_KEY_STORAGE_KEY = "googleAiApiKey";
    const API_MODEL_STORAGE_KEY = "googleAiModelName";

    // --- ğŸ¨ v1.5.0/v1.5.5ï¼šAI æç¤ºè© (ç”¨æ–¼ JSON è¼¸å‡º) ---
    // ( ... AI æç¤ºè©ç›¸é—œå¸¸æ•¸ ... )
    const gradeMap = { 'ä¸€': 'G1', 'äºŒ': 'G2', 'ä¸‰': 'G3', 'å››': 'G4', 'äº”': 'G5', 'å…­': 'G6' };
    const semesterMap = { 'ä¸Š': 'S1', 'ä¸‹': 'S2' };
    // ğŸ¨ v1.5.8 æç¤º (éœ€æ±‚ 3)ï¼š'èµ·': 'L1Z' çš„ AI åµæ¸¬è¦å‰‡ä¸è®Šï¼Œä½†æ’åºè¦å‰‡å·²ä¿®æ”¹ã€‚
    const lessonMap = { 'ä¸€': 'L1', 'äºŒ': 'L2', 'ä¸‰': 'L3', 'å››': 'L4', 'äº”': 'L5', 'å…­': 'L6', 'ä¸ƒ': 'L7', 'å…«': 'L8', 'ä¹': 'L9', 'å': 'L10', 'åä¸€': 'L11', 'åäºŒ': 'L12', 'èµ·': 'L1Z' };

    const AI_BASE_PROMPT = `æ‚¨æ˜¯ä¸€å€‹å°ˆæ¥­çš„è³‡æ–™åˆ†æå¸«ã€‚è«‹åˆ†æä»¥ä¸‹æä¾›çš„æ–‡å­—ï¼Œä¸¦**åš´æ ¼ä¾ç…§**æŒ‡å®šçš„ JSON æ ¼å¼å›å‚³çµæœã€‚
    **é‡è¦è¦å‰‡ï¼š**
    1.  **å¹´ç´š/å­¸æœŸå°æ‡‰**ï¼šè«‹ä½¿ç”¨æ­¤å°æ‡‰è¡¨ï¼š${JSON.stringify(gradeMap)} å’Œ ${JSON.stringify(semesterMap)}ã€‚
    2.  **èª²æ¬¡å°æ‡‰**ï¼šè«‹ä½¿ç”¨æ­¤å°æ‡‰è¡¨ï¼š${JSON.stringify(lessonMap)}ã€‚
    3.  **JSON æ ¼å¼**ï¼šæ‚¨çš„å›è¦†**å¿…é ˆ**æ˜¯ä¸€å€‹åˆæ³•çš„ JSON é™£åˆ—ï¼Œä¸åŒ…å«ä»»ä½• JSON ä»¥å¤–çš„èªªæ˜æ–‡å­—ã€‚
    ---
    `;
    const AI_PROMPT_SHENGZI = AI_BASE_PROMPT + `
    **ä»»å‹™**ï¼šåˆ†æå–®è¡Œå¯†é›†å‹çš„ç”Ÿå­—è³‡æ–™ã€‚
    **è¼¸å‡ºæ ¼å¼**ï¼šè«‹å›å‚³ä¸€å€‹ JSON é™£åˆ—ï¼Œæ ¼å¼å¦‚ä¸‹ (ç”Ÿå­—å…§å®¹è«‹ç§»é™¤æ‰€æœ‰ç©ºæ ¼)ï¼š
    \`[
      {"grade": "G5", "semester": "S1", "lesson": "L1", "content": "å …è€å‹å…ƒèŸæ“ç¹©åˆ·è†é­ä¿‚å……ä¾›å‡¸å½¼å”èæ´½è«¦"}
    ]\`
    ---
    è«‹é–‹å§‹åˆ†æä»¥ä¸‹è³‡æ–™ï¼š
    `;
    const AI_PROMPT_LESSON_TEXT = AI_BASE_PROMPT + `
    **ä»»å‹™**ï¼šåˆ†æå¤šæ®µè½çš„é•·æ–‡ä»¶ï¼Œå°‡æ¯ä¸€èª²çš„å®Œæ•´èª²æ–‡æ“·å–å‡ºä¾†ã€‚
    **è¼¸å‡ºæ ¼å¼**ï¼šè«‹å›å‚³ä¸€å€‹ JSON é™£åˆ—ï¼Œæ ¼å¼å¦‚ä¸‹ (content å¿…é ˆåŒ…å«å¾ "ç¬¬Xèª²" é–‹å§‹çš„å®Œæ•´åŸæ–‡)ï¼š
    \`[
      {"grade": "G5", "semester": "S1", "lesson": "L1", "content": "ç¬¬ä¸€èª² ä½ æˆ‘ä¹‹é–“ è”¡ä»å‰... (å®Œæ•´å…§æ–‡èˆ‡è³æ)"}
    ]\`
    ---
    è«‹é–‹å§‹åˆ†æä»¥ä¸‹è³‡æ–™ï¼š
    `;
    const AI_PROMPT_TERMS = AI_BASE_PROMPT + `
    **ä»»å‹™**ï¼šåˆ†æå‚™èª²è³‡æ–™ï¼Œåƒ…æ“·å– "â–  èªè©è§£é‡‹" å€å¡Šä¸­çš„æ‰€æœ‰èªè©ã€‚
    **è¼¸å‡ºæ ¼å¼**ï¼šè«‹å›å‚³ä¸€å€‹ JSON é™£åˆ— (å‡è¨­æ–‡ä»¶åªé‡å°ä¸€èª²)ï¼Œcontent æ‡‰ç‚ºä¸€å€‹åŒ…å«æ‰€æœ‰èªè©çš„å­—ä¸²é™£åˆ—ï¼š
    \`[
      {"grade": "G5", "semester": "S1", "lesson": "L1", "content": ["å …å®š", "è€å‹", "å¤šå…ƒ", "åˆºèŸ", "æ“æŠ±"]}
    ]\`
    ---
    è«‹é–‹å§‹åˆ†æä»¥ä¸‹è³‡æ–™ï¼š
    `;
    const AI_PROMPT_PATTERNS = AI_BASE_PROMPT + `
    **ä»»å‹™**ï¼šåˆ†æå‚™èª²è³‡æ–™ï¼Œæ“·å– "çŸ­èªç·´ç¿’"ã€"å¥å‹ç·´ç¿’" å’Œ "é€ å¥ç·´ç¿’" çš„æ ¸å¿ƒå…§å®¹ã€‚
    **åˆ†æè¦å‰‡ (ä»¿ v2.4.1 é‚è¼¯)ï¼š**
    1.  **çŸ­èªç·´ç¿’**ï¼šæ‰¾å‡ºèª²æ–‡ä¾‹å¥ (ä¾‹å¦‚ï¼š1. ç«‹ä¸‹ã€Œå®Œç’§æ­¸è¶™ã€çš„å¥‡åŠŸ)ï¼Œä¸¦åƒè€ƒå…¶ä¸‹çš„ç¯„æœ¬å¥ (ä¾‹å¦‚ï¼š(1) ç«‹ä¸‹å…¨åœ‹å† è»çš„æˆç¸¾)ï¼Œæ‰¾å‡ºå¯æ›¿æ›çš„è©ï¼Œä¸¦åªè¼¸å‡ºèª²æ–‡ä¾‹å¥ï¼Œå°‡å¯æ›¿æ›éƒ¨åˆ†ç”¨å…¨å½¢æ‹¬è™Ÿã€Œï¼ˆï¼‰ã€åŒ…èµ·ä¾†ã€‚ (ä¾‹å¦‚ï¼šç«‹ä¸‹ï¼ˆã€Œå®Œç’§æ­¸è¶™ã€ï¼‰çš„ï¼ˆå¥‡åŠŸï¼‰)
    2.  **å¥å‹ç·´ç¿’**ï¼šæŠ½å–å‡ºæ ¸å¿ƒå¥æ§‹ï¼Œç”¨ ... ä»£è¡¨å¯è®Šå‹•çš„éƒ¨åˆ†ã€‚ (ä¾‹å¦‚ï¼šæ¯åˆ°...æ™‚ï¼Œ...å°±...ï¼Œä»¥å…...)
    3.  **é€ å¥ç·´ç¿’**ï¼šåªæŠ½å–å‡ºç›®æ¨™èªè©æœ¬èº« (ä¾‹å¦‚ï¼š1. ç¾è¾±)ã€‚ (ä¾‹å¦‚ï¼šç¾è¾±)
    **è¼¸å‡ºæ ¼å¼**ï¼šè«‹å›å‚³ä¸€å€‹ JSON é™£åˆ— (å‡è¨­æ–‡ä»¶åªé‡å°ä¸€èª²)ï¼Œcontent æ‡‰ç‚ºä¸€å€‹åŒ…å«æ‰€æœ‰åˆ†æçµæœçš„**å­—ä¸²é™£åˆ—**ï¼š
    \`[
      {"grade": "G5", "semester": "S1", "lesson": "L3", "content": ["ç«‹ä¸‹ï¼ˆã€Œå®Œç’§æ­¸è¶™ã€ï¼‰çš„ï¼ˆå¥‡åŠŸï¼‰", "é€™ï¼ˆä»¶äº‹ï¼‰è®“ï¼ˆå»‰é —ï¼‰ï¼ˆååˆ†ï¼‰ï¼ˆä¸æ»¿ï¼‰", "æ¯åˆ°...æ™‚ï¼Œ...å°±...ï¼Œä»¥å…...", "é€£...éƒ½æœƒæ€éº¼æ¨£ï¼Œæ›´ä½•æ³...", "å¦‚æœ...ï¼Œä¸æ˜¯æ­£å¥½è®“...ï¼Ÿ", "ç¾è¾±", "æ‡¦å¼±", "å”åŠ©"]}
    ]\`
    ---
    è«‹é–‹å§‹åˆ†æä»¥ä¸‹è³‡æ–™ï¼š
    `;


    // --- ğŸ¨ v1.5.0 å‡ç´šï¼šAI API è¨­å®šç®¡ç† ---
    function saveAiSettings() {
        const apiKey = dom_v1_5.apiKeyInput.value.trim();
        const modelName = dom_v1_5.apiModelInput.value.trim();
        
        if (apiKey) {
            localStorage.setItem(API_KEY_STORAGE_KEY, apiKey);
            dom_v1_5.apiKeyInput.value = ""; 
        }
        if (modelName) {
            localStorage.setItem(API_MODEL_STORAGE_KEY, modelName);
        }

        if (apiKey || modelName) {
             showToast("âœ… AI è¨­å®šå·²å„²å­˜ï¼");
             loadAiSettingsStatus();
        } else {
            showToast("âŒ è«‹è‡³å°‘è¼¸å…¥ä¸€é …è¨­å®š", "error");
        }
    }

    function loadAiSettingsStatus() {
        const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        const storedModel = localStorage.getItem(API_MODEL_STORAGE_KEY) || dom_v1_5.apiModelInput.value; 
        
        dom_v1_5.apiModelInput.value = storedModel; 

        if (storedKey) {
            dom_v1_5.aiSettingsStatus.textContent = `é‡‘é‘°å·²å„²å­˜ (å„²å­˜æ–¼æœ¬æ©Ÿ)ï½œæ¨¡å‹: ${storedModel}`;
        } else {
            dom_v1_5.aiSettingsStatus.textContent = `å°šæœªè¨­å®š API é‡‘é‘°ï½œæ¨¡å‹: ${storedModel}`;
        }
    }


    // --- Toast æç¤º ---
    function showToast(message, type = 'success') {
        dom.toastMessage.textContent = message;
        const successColor = 'bg-blue-600';
        const errorColor = 'bg-red-600';
        const infoColor = 'bg-gray-700';
        
        dom.toast.classList.remove(successColor, errorColor, infoColor, 'translate-x-full', 'opacity-0');
        
        let colorClass = successColor;
        if (type === 'error') colorClass = errorColor;
        if (type === 'info') colorClass = infoColor;
        
        dom.toast.classList.add(colorClass, 'opacity-100');

        setTimeout(() => {
            dom.toast.classList.add('translate-x-full', 'opacity-0');
        }, 3000);
    }

    // --- ğŸ¨ v1.5.9 ä¿®æ­£ (éœ€æ±‚ 2)ï¼šç™»å…¥ç‹€æ…‹ç®¡ç† ---
    function updateAdminControls() {
        if (sessionStorage.getItem(ADMIN_AUTH_KEY) === 'true') {
            dom.logoutBtn.classList.remove('hidden');
            dom.settingsBtn.title = "é–‹å•Ÿç®¡ç†å¾Œå°";
        } else {
            dom.logoutBtn.classList.add('hidden');
            dom.settingsBtn.title = "ç™»å…¥ç®¡ç† (å•Ÿç”¨ Quick Edit)";
        }
    }

    // --- ğŸ¨ v1.5.8 æ–°å¢ (éœ€æ±‚ 1)ï¼šQuick Edit è§¸ç™¼å‡½å¼ ---
    function quickEditUnit(basePath, unitId) {
        // basePath is [Pub, Sub, Sem, Grade]
        console.log("Quick Edit for:", ...basePath, unitId);
        
        // 1. é–‹å•Ÿ Modal (ä¸é‡ç½®)
        openAdminModal(); 

        // 2. å¡«å…¥è¡¨å–®
        adminForm.publisher.value = basePath[0];
        adminForm.subject.value = basePath[1];
        adminForm.semester.value = basePath[2];
        adminForm.grade.value = basePath[3];
        
        // 3. è¨­å®šå–®å…ƒ ID
        showAdminUnitInput(); // åˆ‡æ›åˆ°æ‰‹å‹•è¼¸å…¥æ¡†
        adminForm.unitId.value = unitId; 
        updateAdminDocIdPreview(); // æ›´æ–°é è¦½
        
        // 4. è‡ªå‹•è¼‰å…¥è³‡æ–™
        handleLoadData(); 
    }

    // --- å°è¦½å™¨æ ¸å¿ƒåŠŸèƒ½ ---
    async function fetchExistingPaths() {
        dom.loading.classList.remove("hidden");
        dom.navigator.classList.add("hidden");
        try {
            const querySnapshot = await db.collection(CURRICULUM_COLLECTION).get();
            existingPaths.clear();
            querySnapshot.forEach((doc) => { existingPaths.add(doc.id); });
            console.log(`å·²å¾ Firebase è¼‰å…¥ ${existingPaths.size} ç­†æ•™æè³‡æ–™ã€‚`);
            
            if (existingPaths.size === 0) {
                showToast("âš ï¸ æç¤ºï¼šè¼‰å…¥ 0 ç­†è³‡æ–™ï¼Œè«‹ç¢ºèª Firebase è¨­å®šæˆ–è³‡æ–™åº«", "error");
            }
            checkInitialDataPath("Hanlin_Chinese_S1_G5_");
        } catch (error) {
            console.error("ç„¡æ³•å¾ Firebase è¼‰å…¥è³‡æ–™: ", error);
            showToast("âŒ ç„¡æ³•é€£ç·šè‡³ Firebase è³‡æ–™åº«ï¼è«‹æª¢æŸ¥è¨­å®šã€‚", "error");
        } finally {
            dom.loading.classList.add("hidden");
            dom.navigator.classList.remove("hidden");
        }
    }

    function checkAvailability(pathPrefix) {
        for (const path of existingPaths) { if (path.startsWith(pathPrefix)) return true; }
        return false;
    }
    
    function checkInitialDataPath(pathPrefix) {
        if (checkAvailability(pathPrefix)) {
             currentPathParts = ["Hanlin", "Chinese", "S1", "G5"];
             currentLabels = ["ç¿°æ—", "åœ‹èª", "ä¸Šå­¸æœŸ", "äº”å¹´ç´š"];
             renderNavigator(4); 
        } else { renderNavigator(0); }
    }

    // ğŸ¨ v1.5.9 ä¿®æ­£ (éœ€æ±‚ 3 v2)ï¼šæ’åºæ¼”ç®—æ³•
    function getSortValue(unitId) {
        const upperUnit = unitId.toUpperCase();
        
        // è¦å‰‡ 1: è£œå……è³‡æ–™ (e.g., L1Z, L10Z) - æ¬Šé‡ 10000+
        let match = upperUnit.match(/^L([0-9]+)Z$/);
        if (match && match[1]) {
            // è³¦äºˆé«˜æ¬Šé‡ï¼Œä½¿å…¶æ’åœ¨åŸºç¤èª²ç¨‹ä¹‹å¾Œ
            return 10000 + parseInt(match[1]); // L1Z -> 10001, L12Z -> 10012
        }
        
        // è¦å‰‡ 2: åŸºç¤èª²ç¨‹ (e.g., L1, L12) - æ¬Šé‡ 1-99
        match = upperUnit.match(/^L([0-9]+)$/);
        if (match && match[1]) {
            return parseInt(match[1]); // L1 -> 1, L12 -> 12
        }

        // è¦å‰‡ 3: æ•¸å­¸/ç¤¾æœƒ (e.g., 1-1, 10-1) - æ¬Šé‡ 100+
        match = unitId.match(/^([0-9]+)-([0-9]+)/);
        if (match && match[1] && match[2]) {
            return parseInt(match[1]) * 100 + parseInt(match[2]); // 1-1 -> 101, 10-1 -> 1001
        }

        // è¦å‰‡ 4: ç°¡å–®æ•¸å­— (e.g., 1)
        match = unitId.match(/^([0-9]+)$/);
        if (match && match[1]) {
             return parseInt(match[1]); // 1 -> 1
        }
        
        // è¦å‰‡ 5: å…¶ä»– "L" é–‹é ­è£œå…… (e.g., LA, LB) - æ¬Šé‡ 20000+
        match = upperUnit.match(/^L([A-Y])/); // A-Y (æ’é™¤ Z)
        if (match && match[1]) {
            return 20000 + match[1].charCodeAt(0); // LA -> 20065
        }
        
        // å…¶ä»–ç„¡æ³•è§£æçš„ï¼Œæ’æœ€å¾Œ
        return 99999; 
    }

    async function renderNavigator(level) {
        dom.navigator.innerHTML = "";
        dom.contentArea.classList.add("hidden"); 
        updateBreadcrumb(level);

        if (level < HIERARCHY.length) {
            // --- A. é¡¯ç¤ºéšå±¤æŒ‰éˆ• (ç‰ˆæœ¬ -> å¹´ç´š) ---
            const step = HIERARCHY[level];
            const currentPathPrefix = currentPathParts.join("_") + (currentPathParts.length > 0 ? "_" : "");
            step.options.forEach(option => {
                const nextPathPrefix = currentPathPrefix + option.key;
                const isAvailable = checkAvailability(nextPathPrefix);
                const button = document.createElement("button");
                button.type = "button";
                if (isAvailable) {
                    button.className = "nav-button";
                    button.innerHTML = `<span class="text-2xl font-bold text-blue-600">${option.label}</span>`;
                    button.onclick = () => { currentPathParts.push(option.key); currentLabels.push(option.label); renderNavigator(level + 1); };
                } else {
                    button.className = "nav-button-disabled";
                    button.innerHTML = `<span class="text-2xl font-bold">${option.label}</span><span class="text-sm ml-2">(å°šç„¡è³‡æ–™)</span>`;
                    button.disabled = true;
                }
                dom.navigator.appendChild(button);
            });
            return;
        }
        
        if (level === HIERARCHY.length) {
            // --- B. é¡¯ç¤ºå‹•æ…‹ "å–®å…ƒ" æŒ‰éˆ• (Level 4) ---
            dom.loading.classList.remove("hidden");
            const prefix = currentPathParts.join("_") + "_";
            
            // v1.5.7 æª¢æŸ¥å¿«å–
            let hasCache = false;
            if (Object.keys(currentDocCache).length > 0) {
                const firstKey = Object.keys(currentDocCache)[0];
                if (firstKey.startsWith(prefix)) {
                    hasCache = true;
                } else {
                    currentDocCache = {};
                }
            }

            if (!hasCache) {
                console.log("v1.5.8: é‡æ–°æŠ“å– Level 4 è³‡æ–™");
                try {
                    const querySnapshot = await db.collection(CURRICULUM_COLLECTION)
                        .where(firebase.firestore.FieldPath.documentId(), ">=", prefix)
                        .where(firebase.firestore.FieldPath.documentId(), "<", prefix + "\uf8ff").get();
                    
                    currentDocCache = {}; 
                    if (querySnapshot.empty) { 
                        dom.navigator.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ­¤åˆ†é¡ä¸‹å°šç„¡ä»»ä½•å–®å…ƒè³‡æ–™ã€‚</p>`; 
                        dom.loading.classList.add("hidden");
                        return; 
                    }
                    querySnapshot.forEach((doc) => {
                        const docId = doc.id;
                        currentDocCache[docId] = doc.data(); 
                    });
                } catch(e) { 
                    console.error("æŸ¥è©¢å–®å…ƒå¤±æ•—:", e); showToast("âŒ æŸ¥è©¢å–®å…ƒåˆ—è¡¨å¤±æ•—", "error");
                    dom.loading.classList.add("hidden");
                    return;
                }
            } else {
                 console.log("v1.5.8: ä½¿ç”¨ Level 4 å¿«å–è³‡æ–™");
            }
            
            // --- å¾å¿«å–æ¸²æŸ“ ---
            dom.loading.classList.add("hidden");
            const units = [];
            Object.keys(currentDocCache).forEach(docId => {
                 if (docId.startsWith(prefix)) {
                     const unitId = docId.replace(prefix, "");
                     units.push({ unitId, docId });
                 }
            });

            if (units.length === 0) {
                 dom.navigator.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ­¤åˆ†é¡ä¸‹å°šç„¡ä»»ä½•å–®å…ƒè³‡æ–™ã€‚</p>`; 
                 return;
            }

            // ğŸ¨ v1.5.9 æ’åºä¿®æ­£ (éœ€æ±‚ 3 v2)ï¼šä½¿ç”¨æ–°çš„æ’åºæ¼”ç®—æ³•
            units.sort((a, b) => {
                const numA = getSortValue(a.unitId);
                const numB = getSortValue(b.unitId);
                if (numA !== numB) {
                    return numA - numB;
                }
                return a.unitId.localeCompare(b.unitId); // æ•¸å­—ç›¸åŒæ™‚ï¼Œä¾å­—ä¸²æ’åº
            });
                
            units.forEach(({ unitId, docId }) => {
                const button = document.createElement("button");
                button.type = "button";
                button.className = "nav-button";
                button.innerHTML = `<span class="text-2xl font-bold text-green-700">${unitId}</span>`;
                
                // ğŸ¨ v1.5.8 ä¿®æ”¹ (éœ€æ±‚ 1)ï¼šç¶å®š Quick Edit æˆ–ä¸€èˆ¬å°è¦½
                button.onclick = () => { 
                    if (sessionStorage.getItem(ADMIN_AUTH_KEY) === 'true') {
                        // å¿«é€Ÿç·¨è¼¯æ¨¡å¼ï¼šå‚³å…¥ L4 çš„è·¯å¾‘ + L5 çš„ unitId
                        quickEditUnit(currentPathParts.slice(0, 4), unitId);
                    } else {
                        // ä¸€èˆ¬ç€è¦½æ¨¡å¼
                        currentPathParts.push(unitId); 
                        currentLabels.push(unitId); 
                        renderNavigator(level + 1); 
                    }
                };
                dom.navigator.appendChild(button);
            });
            return;
        }
        
        // --- C. é¡¯ç¤º "å…§å®¹æ¬„ä½" æŒ‰éˆ• (Level 5) ---
        if (level > HIERARCHY.length) { renderContentFields(); }
    }
    
    function updateBreadcrumb(level) {
        dom.breadcrumb.innerHTML = '<button class="hover:underline text-blue-600" data-level="0">é¦–é </button>';
        currentLabels.forEach((label, index) => {
            dom.breadcrumb.innerHTML += ` <span class="mx-1">/</span> <button class="hover:underline text-blue-600" data-level="${index + 1}">${label}</button>`;
        });
        dom.breadcrumb.querySelectorAll("button").forEach(btn => {
            // ğŸ¨ v1.5.8 ä¿®æ”¹ (éœ€æ±‚ 1)ï¼šç¶å®š Quick Edit æˆ–ä¸€èˆ¬å°è¦½
            btn.onclick = () => {
                const targetLevel = parseInt(btn.dataset.level);
                
                // HIERARCHY.length æ˜¯ 4ã€‚ Level 5 (index 4) æ˜¯å–®å…ƒå±¤ç´š [Pub, Sub, Sem, Grade, Unit]
                const unitLevel = HIERARCHY.length + 1; // 5
                
                // æª¢æŸ¥æ˜¯å¦é»æ“ŠéºµåŒ…å±‘çš„æœ€å¾Œä¸€å±¤ (å–®å…ƒå±¤) ä¸”å·²ç™»å…¥
                if (targetLevel === unitLevel && sessionStorage.getItem(ADMIN_AUTH_KEY) === 'true') {
                    // è§¸ç™¼ Quick Edit
                    const unitId = currentPathParts[4];
                    const basePath = currentPathParts.slice(0, 4);
                    quickEditUnit(basePath, unitId);
                } else {
                    // ä¸€èˆ¬å°è¦½
                    currentPathParts = currentPathParts.slice(0, targetLevel);
                    currentLabels = currentLabels.slice(0, targetLevel);
                    
                    if (targetLevel < 4) { 
                        console.log("v1.5.8: æ¸…é™¤å¿«å–ï¼Œå› ç‚ºå°èˆªè‡³ Level " + targetLevel);
                        currentDocCache = {}; 
                    }
                    
                    renderNavigator(targetLevel);
                }
            };
        });
    }
    
    function renderContentFields() {
        const docId = currentPathParts.join("_");
        const data = currentDocCache[docId];
        
        console.log(`v1.5.8: renderContentFields. DocID: ${docId}`, currentDocCache); 
        
        if (!data || !data.content) { 
            console.error("v1.5.8: æ‰¾ä¸åˆ°å¿«å–è³‡æ–™ï¼", docId);
            dom.navigator.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ‰¾ä¸åˆ°è³‡æ–™æˆ–å…§å®¹ç‚ºç©ºã€‚</p>`; 
            return; 
        }
        
        let hasContent = false;
        
        if (data.content.fields && data.content.fields.length > 0) {
            data.content.fields.forEach(field => {
                if (field.label && field.data && field.data.length > 0) { 
                    const button = document.createElement("button");
                    button.type = "button";
                    button.className = "nav-button";
                    button.innerHTML = `<span class="text-2xl font-bold text-indigo-600">${field.label}</span>`;
                    button.onclick = () => showData(field.label, field.data);
                    dom.navigator.appendChild(button);
                    hasContent = true;
                }
            });
        }
        if (data.content.mainText) {
             const button = document.createElement("button");
             button.type = "button";
             button.className = "nav-button";
             button.innerHTML = `<span class="text-2xl font-bold text-indigo-600">ä¸»è¦å…§å®¹ (èª²æ–‡)</span>`;
             button.onclick = () => showData("ä¸»è¦å…§å®¹ (èª²æ–‡)", data.content.mainText);
             dom.navigator.appendChild(button);
             hasContent = true;
        }
        
        if (!hasContent) {
             dom.navigator.innerHTML = `<p class="text-gray-500 col-span-full text-center">æ­¤å–®å…ƒå…§å®¹ç‚ºç©ºã€‚</p>`;
        }
    }

    function showData(label, content) {
        dom.contentTitle.textContent = `${currentLabels.join(" / ")} - ${label}`;
        dom.contentTextArea.value = Array.isArray(content) ? content.join("\n") : (content || "");
        dom.contentArea.classList.remove("hidden");
        dom.copyContentBtn.onclick = () => {
            try { dom.contentTextArea.select(); document.execCommand('copy'); showToast("âœ… å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"); } 
            catch (err) { showToast("âŒ è¤‡è£½å¤±æ•—", "error"); }
        };
    }

    // --- ğŸ¨ v1.5.6 å‡ç´šï¼šç®¡ç†å¾Œå° (Admin Modal) åŠŸèƒ½ ---
    const adminForm = {
        publisher: document.getElementById("adminPublisher"),
        subject: document.getElementById("adminSubject"),
        semester: document.getElementById("adminSemester"),
        grade: document.getElementById("adminGrade"),
        unitId: document.getElementById("adminUnitId"), 
        unitSelector: document.getElementById("adminUnitSelector"),
        labels: [ document.getElementById("adminLabel1"), document.getElementById("adminLabel2"), document.getElementById("adminLabel3"), document.getElementById("adminLabel4"), document.getElementById("adminLabel5") ],
        contents: [ document.getElementById("adminContent1"), document.getElementById("adminContent2"), document.getElementById("adminContent3"), document.getElementById("adminContent4"), document.getElementById("adminContent5") ],
        mainText: document.getElementById("adminMainText"),
        docIdPreview: document.getElementById("adminDocIdPreview"),
    };

    // ç²å– Doc ID (v1.5.6 ä¿®æ”¹)
    function getAdminDocId() {
        const isSelectVisible = !adminForm.unitSelector.classList.contains('hidden');
        const unitIdFromInput = adminForm.unitId.value.trim();
        const unitIdFromSelect = adminForm.unitSelector.value;
        
        let unitId = "";
        if (isSelectVisible) {
            unitId = unitIdFromSelect;
        } else {
            unitId = unitIdFromInput;
        }
        
        if (!unitId || unitId === "") return null; 
        
        return [ 
            adminForm.publisher.value, 
            adminForm.subject.value, 
            adminForm.semester.value, 
            adminForm.grade.value, 
            unitId 
        ].join("_");
    }
    
    // æ›´æ–° Doc ID é è¦½ (v1.5.6 æ–°å¢)
    function updateAdminDocIdPreview() {
        const docId = getAdminDocId();
        if (docId) {
            adminForm.docIdPreview.textContent = `æ–‡ä»¶ ID: ${docId}`;
            adminForm.docIdPreview.className = "text-xs text-blue-700 font-semibold mt-2";
        } else {
            adminForm.docIdPreview.textContent = "æç¤ºï¼šè«‹é¸æ“‡æˆ–è¼¸å…¥ã€Œå–®å…ƒ IDã€";
            adminForm.docIdPreview.className = "text-xs text-red-500 font-semibold mt-2";
        }
    }
    
    // åµæ¸¬å–®å…ƒ (v1.5.6 æ–°å¢)
    async function fetchUnitsForAdmin() {
        showAdminUnitSelector(); // åˆ‡æ› UI
        const prefix = [ 
            adminForm.publisher.value, 
            adminForm.subject.value, 
            adminForm.semester.value, 
            adminForm.grade.value 
        ].join("_") + "_";
        
        showToast(`ğŸ”„ æ­£åœ¨åµæ¸¬ ${prefix}...`);
        adminForm.unitSelector.innerHTML = '<option value="">ğŸ”„ åµæ¸¬ä¸­...</option>';
        adminForm.unitSelector.disabled = true;

        try {
            const querySnapshot = await db.collection(CURRICULUM_COLLECTION)
                .where(firebase.firestore.FieldPath.documentId(), ">=", prefix)
                .where(firebase.firestore.FieldPath.documentId(), "<", prefix + "\uf8ff").get();
            
            if (querySnapshot.empty) {
                adminForm.unitSelector.innerHTML = '<option value="">-- åµæ¸¬ä¸åˆ°ä»»ä½•å–®å…ƒ --</option>';
                showToast("â„¹ï¸ æ­¤åˆ†é¡ä¸‹å°šç„¡å–®å…ƒ", "info");
                return;
            }
            
            const units = [];
            querySnapshot.forEach((doc) => {
                const unitId = doc.id.replace(prefix, ""); 
                units.push(unitId);
            });
            
            // ğŸ¨ v1.5.9 æ’åºä¿®æ­£ (éœ€æ±‚ 3 v2)
            units.sort((a, b) => {
                const numA = getSortValue(a);
                const numB = getSortValue(b);
                if (numA !== numB) {
                    return numA - numB;
                }
                return a.localeCompare(b); // æ•¸å­—ç›¸åŒæ™‚ï¼Œä¾å­—ä¸²æ’åº
            });
            
            adminForm.unitSelector.innerHTML = '<option value="">-- åµæ¸¬å®Œæˆï¼Œè«‹é¸æ“‡ä¸€å€‹å–®å…ƒ --</option>';
            units.forEach(unitId => {
                adminForm.unitSelector.innerHTML += `<option value="${unitId}">${unitId}</option>`;
            });
            updateAdminDocIdPreview();

        } catch (e) {
            console.error("åµæ¸¬å–®å…ƒå¤±æ•—:", e);
            showToast("âŒ åµæ¸¬å–®å…ƒåˆ—è¡¨å¤±æ•—", "error");
            adminForm.unitSelector.innerHTML = '<option value="">âŒ åµæ¸¬å¤±æ•—</option>';
        } finally {
            adminForm.unitSelector.disabled = false;
        }
    }
    
    // é¡¯ç¤ºå–®å…ƒä¸‹æ‹‰é¸å–® (v1.5.6 æ–°å¢)
    function showAdminUnitSelector() {
        adminForm.unitSelector.classList.remove("hidden");
        document.querySelector("label[for='adminUnitSelector']").classList.remove("hidden");
        adminForm.unitId.classList.add("hidden");
        document.querySelector("label[for='adminUnitId']").classList.add("hidden");
        updateAdminDocIdPreview();
    }

    // é¡¯ç¤ºå–®å…ƒæ–‡å­—è¼¸å…¥æ¡† (v1.5.6 æ–°å¢)
    function showAdminUnitInput() {
        adminForm.unitSelector.classList.add("hidden");
        document.querySelector("label[for='adminUnitSelector']").classList.add("hidden");
        adminForm.unitId.classList.remove("hidden");
        document.querySelector("label[for='adminUnitId']").classList.remove("hidden");
        adminForm.unitId.value = "";
        adminForm.unitId.focus();
        updateAdminDocIdPreview();
    }

    // æ¸…ç©ºè¡¨å–® (v1.5.6 ä¿®æ”¹)
    function clearAdminFormFields(clearUnitSelector = false) { // v1.5.7 ä¿®æ­£
        adminForm.labels.forEach(input => input.value = "");
        adminForm.contents.forEach(textarea => textarea.value = "");
        adminForm.mainText.value = "";
        
        if (clearUnitSelector) {
            adminForm.unitSelector.innerHTML = ''; 
        }
        updateAdminDocIdPreview();
    }

    // è¼‰å…¥è³‡æ–™ (v1.5.6 ä¿®æ”¹)
    async function handleLoadData() {
        const docId = getAdminDocId();
        if (!docId) { showToast("âŒ è«‹å…ˆé¸æ“‡æˆ–è¼¸å…¥ã€Œå–®å…ƒ IDã€", "error"); return; }
        
        // v1.5.7 ä¿®æ­£ï¼šåªæ¸…ç©ºå…§å®¹æ¬„ä½
        clearAdminFormFields(false); 

        showToast(`ğŸ”„ æ­£åœ¨è¼‰å…¥ ${docId} ...`);
        try {
            const docRef = db.collection(CURRICULUM_COLLECTION).doc(docId);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                if (data.content) {
                    if (data.content.fields) {
                        data.content.fields.forEach((field, index) => {
                            if (index < adminForm.labels.length) {
                                adminForm.labels[index].value = field.label || "";
                                adminForm.contents[index].value = (field.data || []).join("\n");
                            }
                        });
                    }
                    adminForm.mainText.value = data.content.mainText || "";
                }
                showToast("âœ… ç¾æœ‰è³‡æ–™è¼‰å…¥æˆåŠŸï¼");
            } else { showToast("â„¹ï¸ é€™æ˜¯ä¸€ç­†æ–°è³‡æ–™ï¼Œå°šç„¡å…§å®¹ã€‚"); }
        } catch (error) { console.error("è¼‰å…¥è³‡æ–™å¤±æ•—:", error); showToast("âŒ è¼‰å…¥è³‡æ–™å¤±æ•—ï¼", "error"); }
    }

    // å„²å­˜è³‡æ–™ (v1.5.6 ä¿®æ”¹)
    async function handleSaveData() {
        const docId = getAdminDocId();
        if (!docId) { showToast("âŒ è«‹è¼¸å…¥ã€Œå–®å…ƒ IDã€æ‰èƒ½å„²å­˜", "error"); return; }
        
        const docRef = db.collection(CURRICULUM_COLLECTION).doc(docId);
        let existingContent = { mainText: "", fields: [] };

        try {
            const docSnap = await docRef.get();
            if (docSnap.exists && docSnap.data().content) {
                existingContent = docSnap.data().content;
                if (!existingContent.fields) {
                    existingContent.fields = [];
                }
            }
        } catch (getErr) {
            console.error("è¼‰å…¥èˆŠè³‡æ–™å¤±æ•— (æ‰‹å‹•å„²å­˜):", getErr);
            showToast("âŒ è¼‰å…¥èˆŠè³‡æ–™å¤±æ•—ï¼Œç„¡æ³•å„²å­˜ï¼", "error");
            return;
        }

        const newFields = [];
        adminForm.labels.forEach((labelInput, index) => {
            const label = labelInput.value.trim();
            const contentText = adminForm.contents[index].value.trim();
            if (label) {
                newFields.push({ 
                    label: label, 
                    data: contentText.split('\n').map(s => s.trim()).filter(Boolean) 
                });
            }
        });

        const contentToSave = {
            mainText: adminForm.mainText.value.trim(),
            fields: newFields
        };
        
        const dataToSave = {
            id: docId,
            publisher: adminForm.publisher.value, 
            subject: adminForm.subject.value, 
            semester: adminForm.semester.value, 
            grade: adminForm.grade.value, 
            unit: docId.split('_').pop(), 
            content: contentToSave, 
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection(CURRICULUM_COLLECTION).doc(docId).set(dataToSave);
            existingPaths.add(docId);
            showToast("âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜åˆ°é›²ç«¯ï¼");
            dom.adminModal.classList.remove("visible"); dom.adminModal.classList.add("hidden");
            
            currentDocCache = {}; 
            renderNavigator(currentPathParts.length);
        } catch (error) { console.error("å„²å­˜è³‡æ–™å¤±æ•—:", error); showToast("âŒ å„²å­˜å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error"); }
    }
    
    // ğŸ¨ v1.5.9 æ–°å¢ (éœ€æ±‚ 1)ï¼šåˆªé™¤å–®å…ƒ
    async function handleDeleteDocument() {
        const docId = getAdminDocId();
        if (!docId) { 
            showToast("âŒ è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å–®å…ƒ", "error"); 
            return; 
        }

        // é›™é‡ç¢ºèª
        if (!confirm(`æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ä»¥ä¸‹æ–‡ä»¶å—ï¼Ÿ\n\n${docId}\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
            return;
        }
        if (!confirm(`å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤ ${docId} å—ï¼Ÿ`)) {
            return;
        }

        showToast("â³ æ­£åœ¨åˆªé™¤...", "info");
        try {
            await db.collection(CURRICULUM_COLLECTION).doc(docId).delete();
            
            // å¾æœ¬åœ°å¿«å–ç§»é™¤
            existingPaths.delete(docId); 
            delete currentDocCache[docId]; 
            
            showToast("âœ… æ–‡ä»¶å·²æˆåŠŸåˆªé™¤ï¼", "success");
            dom.adminModal.classList.remove("visible"); 
            dom.adminModal.classList.add("hidden");
            
            // åˆ·æ–°å°è¦½å™¨ (å›åˆ°ä¸Šä¸€å±¤)
            const currentLevel = currentPathParts.length;
            if (currentLevel > HIERARCHY.length) {
                // å¦‚æœåœ¨ L5 (e.g. L1)ï¼Œå›åˆ° L4 (å–®å…ƒåˆ—è¡¨)
                currentPathParts = currentPathParts.slice(0, HIERARCHY.length);
                currentLabels = currentLabels.slice(0, HIERARCHY.length);
                renderNavigator(HIERARCHY.length);
            } else {
                renderNavigator(currentPathParts.length);
            }

        } catch (error) {
            console.error("åˆªé™¤æ–‡ä»¶å¤±æ•—:", error);
            showToast("âŒ åˆªé™¤å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚", "error");
        }
    }
    
    // --- æ‰¹æ¬¡ä¸Šå‚³ ---

    // 1. æ‰¹æ¬¡æ—¥èªŒ
    function logBatch(message, type = 'info') {
        const p = document.createElement('p');
        p.textContent = message;
        p.className = type;
        dom.batchLog.appendChild(p);
        dom.batchLog.scrollTop = dom.batchLog.scrollHeight; 
    }

    // 2. æª”æ¡ˆè®€å– ( .txt / .pdf )
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) { dom.textInputArea.value = ""; return; }
        const reader = new FileReader();
        if (file.type === "text/plain") {
            reader.onload = (e) => { dom.textInputArea.value = e.target.result; };
            reader.readAsText(file);
        } 
        else if (file.type === "application/pdf") {
            dom.textInputArea.value = "ğŸ”„ æ­£åœ¨è®€å– PDF æª”æ¡ˆï¼Œè«‹ç¨å€™...";
            reader.onload = async (e) => {
                try {
                    const pdfData = new Uint8Array(e.target.result);
                    const pdf = await pdfjsLib.getDocument(pdfData).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str + (item.hasEOL ? "\n" : " ")).join('');
                        fullText += pageText + "\n\n"; 
                    }
                    dom.textInputArea.value = fullText;
                    showToast("âœ… PDF è®€å–å®Œæˆï¼", "success");
                } catch (err) {
                    console.error("PDF è§£æå¤±æ•—:", err);
                    dom.textInputArea.value = `âŒ PDF è§£æå¤±æ•—ï¼š${err.message}`;
                    showToast("âŒ PDF è§£æå¤±æ•—ï¼", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        } 
        else {
            showToast(`âŒ ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼: ${file.type}`, "error");
            dom.textInputArea.value = `âŒ ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼: ${file.type}ã€‚è«‹ä¸Šå‚³ .txt æˆ– .pdfã€‚`;
            event.target.value = null;
        }
    }

    // 3. å‘¼å« Gemini API
    // ğŸ¨ v1.5.9 ä¿®æ”¹ (éœ€æ±‚ 3)ï¼šå¢åŠ  extraPrompt åƒæ•¸
    async function callGeminiApi(prompt, rawText, extraPrompt = "") {
        const apiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        const modelName = localStorage.getItem(API_MODEL_STORAGE_KEY);

        if (!apiKey) {
            logBatch("âŒ éŒ¯èª¤ï¼šå°šæœªè¨­å®š Google AI API é‡‘é‘°ã€‚", "error");
            showToast("âŒ è«‹å…ˆåœ¨ AI è¨­å®šä¸­å„²å­˜æ‚¨çš„ API é‡‘é‘°", "error");
            return null; 
        }
        
        if (!modelName) {
            logBatch("âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° AI æ¨¡å‹åç¨±ã€‚è«‹å„²å­˜è¨­å®šã€‚", "error");
            showToast("âŒ æ‰¾ä¸åˆ° AI æ¨¡å‹åç¨±ã€‚è«‹å„²å­˜è¨­å®šã€‚", "error");
            return null;
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        
        // ğŸ¨ v1.5.9 (éœ€æ±‚ 3)ï¼šçµ„åˆé¡å¤–æŒ‡ä»¤
        let fullPrompt = prompt;
        if (extraPrompt) {
            fullPrompt += `\n**é¡å¤–æŒ‡ä»¤ (å„ªå…ˆåº¦é«˜)ï¼š**\n${extraPrompt}\n--- (é¡å¤–æŒ‡ä»¤çµæŸ) ---\n`;
        }
        fullPrompt += "\n" + rawText;
        
        const payload = { contents: [{ parts: [{ text: fullPrompt }] }] };

        try {
            logBatch(`â³ æ­£åœ¨å‘¼å« AI (æ¨¡å‹: ${modelName})...`, "info");
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = errorData.error?.message || `API è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}`;
                console.error("AI å‘¼å«å¤±æ•—:", errorMessage);
                logBatch(`âŒ AI å‘¼å«å¤±æ•—: ${errorMessage}`, "error");
                return null;
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                logBatch("âœ… AI å›æ‡‰æ¥æ”¶å®Œç•¢ï¼Œæ­£åœ¨è§£æ...", "success");
                const aiText = candidate.content.parts[0].text;
                const cleanedJson = aiText.replace(/^```json\n/, '').replace(/\n```$/, '').trim();
                return cleanedJson;

            } else {
                if (candidate && candidate.finishReason && candidate.finishReason !== "STOP") {
                     logBatch(`âŒ AI å›æ‡‰å›  ${candidate.finishReason} è€Œä¸­æ–·ã€‚`, 'error');
                     return null;
                }
                logBatch("âŒ å¾ API æ”¶åˆ°çš„å›æ‡‰æ ¼å¼ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚", "error");
                return null;
            }
        } catch (error) {
            console.error("AI å‘¼å«å¤±æ•—:", error);
            logBatch(`âŒ AI å‘¼å«å¤±æ•—: ${error.message}`, "error");
            return null;
        }
    }


    // 4. æ‰¹æ¬¡ä¸Šå‚³è§¸ç™¼å‡½å¼ (v1.5.7)
    // ğŸ¨ v1.5.9 ä¿®æ”¹ (éœ€æ±‚ 3)ï¼šå‚³é extraPrompt
    async function handleBatchUpload() {
        const rawText = dom.textInputArea.value;
        if (!rawText || rawText.trim() === "") {
            showToast("âŒ æ–‡å­—æ¡†ä¸­æ²’æœ‰å…§å®¹å¯åˆ†æ", "error");
            return;
        }

        const analysisMode = dom.analysisMode.value;
        const extraPrompt = dom.aiExtraPrompt.value.trim(); // ğŸ¨ v1.5.9

        dom.batchLog.innerHTML = "";
        dom.batchLog.classList.remove('hidden');
        dom.batchUploadBtn.disabled = true;
        dom.batchUploadBtn.textContent = "â³ AI åˆ†æä¸­ï¼Œè«‹ç¨å€™...";
        
        dom.aiPreviewArea.classList.add('hidden');
        dom.confirmBatchUploadBtn.disabled = false;

        try {
            let prompt;
            if (analysisMode === "ai_shengzi") prompt = AI_PROMPT_SHENGZI;
            else if (analysisMode === "ai_lesson_text") prompt = AI_PROMPT_LESSON_TEXT;
            else if (analysisMode === "ai_terms") prompt = AI_PROMPT_TERMS;
            else if (analysisMode === "ai_patterns") prompt = AI_PROMPT_PATTERNS;
            else {
                 logBatch(`âŒ æœªçŸ¥çš„åˆ†ææ¨¡å¼: ${analysisMode}`, 'error');
                 return;
            }
                
            const aiResponseJson = await callGeminiApi(prompt, rawText, extraPrompt); // ğŸ¨ v1.5.9
            
            if (!aiResponseJson) {
                throw new Error("AI æœªå›å‚³æœ‰æ•ˆè³‡æ–™ã€‚");
            }
            
            // ğŸ¨ v1.5.8 (éœ€æ±‚ 2)ï¼šé¡¯ç¤ºçµæœä¾›ç·¨è¼¯
            dom.aiPreviewArea.classList.remove('hidden');
            try {
                const parsedJson = JSON.parse(aiResponseJson); 
                renderAiPreview(parsedJson); // ğŸ¨ v1.5.8 æ–°å‡½å¼
                
                dom.aiResultPreview.classList.add('hidden'); // éš±è—èˆŠçš„
                dom.aiResultPreviewDynamic.classList.remove('hidden'); // é¡¯ç¤ºæ–°çš„
                dom.confirmBatchUploadBtn.disabled = false;
                logBatch("âœ… AI åˆ†æå®Œæˆï¼è«‹æª¢æŸ¥ä¸‹æ–¹æ–¹æ ¼ï¼Œå¯æ‰‹å‹•ç·¨è¼¯ã€‚", 'success');
                
            } catch (jsonError) {
                console.error("AI JSON è§£æå¤±æ•—:", jsonError);
                logBatch(`âŒ AI å›å‚³çš„ JSON æ ¼å¼éŒ¯èª¤: ${jsonError.message}`, 'error');
                logBatch(`--- AI åŸå§‹å›æ‡‰ (è«‹æª¢æŸ¥) ---`, 'info');
                logBatch(aiResponseJson, 'info');
                
                dom.aiResultPreview.value = aiResponseJson; // é¡¯ç¤ºåŸå§‹éŒ¯èª¤
                dom.aiResultPreview.classList.remove('hidden'); // é¡¯ç¤ºèˆŠçš„
                dom.aiResultPreviewDynamic.classList.add('hidden'); // éš±è—æ–°çš„
                dom.confirmBatchUploadBtn.disabled = true; // æ ¼å¼éŒ¯èª¤ï¼Œç¦æ­¢ä¸Šå‚³
            }

        } catch (error) {
            console.error("æ‰¹æ¬¡åˆ†æå¤±æ•—:", error);
            if (error.message !== "AI æœªå›å‚³æœ‰æ•ˆè³‡æ–™ã€‚") { 
                logBatch(`âŒ ç™¼ç”Ÿåš´é‡éŒ¯èª¤: ${error.message}`, 'error');
            }
            showToast("âŒ æ‰¹æ¬¡åˆ†æå¤±æ•—ï¼", "error");
        } finally {
            dom.batchUploadBtn.disabled = false;
            dom.batchUploadBtn.textContent = "ğŸ”¬ é‡æ–°åˆ†æ";
        }
    }
    
    // ğŸ¨ v1.5.8 æ–°å¢ (éœ€æ±‚ 2)ï¼šæ¸²æŸ“ AI é è¦½æ–¹æ ¼
    function renderAiPreview(parsedData) {
        const container = dom.aiResultPreviewDynamic;
        container.innerHTML = ''; // æ¸…ç©º
        const analysisMode = dom.analysisMode.value;

        parsedData.forEach((item, index) => {
            const box = document.createElement('div');
            box.className = 'ai-preview-box';
            box.dataset.index = index;

            // åˆ¤æ–· content é¡å‹
            let contentValue = '';
            if (Array.isArray(item.content)) {
                contentValue = item.content.join('\n');
            } else if (typeof item.content === 'string') {
                contentValue = item.content;
            }

            box.innerHTML = `
                <div>
                    <label>Grade (å¹´ç´š)</label>
                    <input type="text" data-field="grade" value="${item.grade || ''}">
                </div>
                <div>
                    <label>Semester (å­¸æœŸ)</label>
                    <input type="text" data-field="semester" value="${item.semester || ''}">
                </div>
                <div class="md:col-span-2">
                    <label>Lesson (å–®å…ƒ ID)</label>
                    <input type="text" data-field="lesson" value="${item.lesson || ''}">
                </div>
                <div class="content-area">
                    <label>Content (å…§å®¹)</label>
                    <textarea data-field="content" rows="6">${contentValue}</textarea>
                </div>
            `;
            container.appendChild(box);
        });
    }
    
    // ğŸ¨ v1.5.8 æ–°å¢ (éœ€æ±‚ 2)ï¼šå¾æ–¹æ ¼é‡å»º JSON
    function reconstructJsonFromPreview() {
        const container = dom.aiResultPreviewDynamic;
        const boxes = container.querySelectorAll('.ai-preview-box');
        const newData = [];
        const analysisMode = dom.analysisMode.value;

        boxes.forEach(box => {
            const grade = box.querySelector('input[data-field="grade"]').value.trim();
            const semester = box.querySelector('input[data-field="semester"]').value.trim();
            const lesson = box.querySelector('input[data-field="lesson"]').value.trim();
            const contentText = box.querySelector('textarea[data-field="content"]').value;
            
            let content;
            // æ ¹æ“šåˆ†ææ¨¡å¼ï¼Œæ±ºå®š content æ˜¯é™£åˆ—é‚„æ˜¯å­—ä¸²
            if (analysisMode === 'ai_terms' || analysisMode === 'ai_patterns') {
                content = contentText.split('\n').map(s => s.trim()).filter(Boolean);
            } else {
                content = contentText; // ai_shengzi å’Œ ai_lesson_text æ˜¯å­—ä¸²
            }
            
            newData.push({ grade, semester, lesson, content });
        });
        
        return newData;
    }
    
    // ğŸ¨ v1.5.8 ä¿®æ”¹ (éœ€æ±‚ 2)ï¼šç¢ºèªä¸¦ä¸Šå‚³ (å¾æ–¹æ ¼è®€å–)
    async function handleConfirmBatchUpload() {
        let parsedData = [];
        try {
            // å¾æ–¹æ ¼é‡å»ºè³‡æ–™ï¼Œä¸å†è§£æ JSON
            parsedData = reconstructJsonFromPreview(); 
            logBatch(`â„¹ï¸ (v1.5.8) ä½¿ç”¨è€…å·²ç¢ºèªæ–¹æ ¼ï¼Œå…± ${parsedData.length} ç­†è³‡æ–™ã€‚`, 'info');
        } catch (error) {
            logBatch(`âŒ è®€å–æ–¹æ ¼è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            return; 
        }
        
        if (parsedData.length === 0) {
             logBatch('âŒ æ‰¾ä¸åˆ°ä»»ä½•è³‡æ–™ã€‚', 'error');
             return;
        }

        const analysisMode = dom.analysisMode.value;
        let dataType = 'unknown';
        if (analysisMode === "ai_shengzi") dataType = 'shengzi_ai';
        else if (analysisMode === "ai_lesson_text") dataType = 'lesson_text_ai';
        else if (analysisMode === "ai_terms") dataType = 'terms_ai';
        else if (analysisMode === "ai_patterns") dataType = 'patterns_ai';
        
        if (dataType === 'unknown') {
             logBatch('âŒ ç„¡æ³•ç¢ºå®šè³‡æ–™é¡å‹ï¼Œè«‹é‡æ–°åˆ†æã€‚', 'error');
             return;
        }

        dom.batchUploadBtn.disabled = true;
        dom.confirmBatchUploadBtn.disabled = true;
        dom.confirmBatchUploadBtn.textContent = "â³ ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™...";
        logBatch('â˜ï¸ é–‹å§‹ä¸Šå‚³è‡³ Firebase (v1.5.8)...', 'info');

        try {
            const BATCH_SIZE = 10; 
            for (let i = 0; i < parsedData.length; i += BATCH_SIZE) {
                const batch = parsedData.slice(i, i + BATCH_SIZE);

                const processItem = async (item) => {
                    const publisher = "Hanlin"; // é è¨­ ç¿°æ—
                    const subject = "Chinese";  // é è¨­ åœ‹èª
                    
                    if (!item.grade || !item.semester || !item.lesson) {
                        logBatch(`âŒ é …ç›®è³‡æ–™ä¸å…¨ (ç¼ºå°‘ grade/semester/lesson)ï¼Œå·²è·³éã€‚`, 'error');
                        return;
                    }

                    const docId = `${publisher}_${subject}_${item.semester}_${item.grade}_${item.lesson}`;
                    const docRef = db.collection(CURRICULUM_COLLECTION).doc(docId);
                    let existingContent = { mainText: "", fields: [] }; 

                    try {
                        const docSnap = await docRef.get();
                        if (docSnap.exists && docSnap.data().content) {
                            existingContent = docSnap.data().content;
                            if (!existingContent.fields) {
                                existingContent.fields = [];
                            }
                        }
                    } catch (getErr) {
                        logBatch(`âŒ è®€å– ${docId} å¤±æ•—: ${getErr.message}`, 'error');
                        return; 
                    }

                    function updateOrAddField(fieldsArray, label, data) {
                        const existingFieldIndex = fieldsArray.findIndex(f => f.label === label);
                        if (existingFieldIndex > -1) {
                            fieldsArray[existingFieldIndex].data = data;
                        } else {
                            fieldsArray.push({ label: label, data: data });
                        }
                    }

                    if (dataType === 'shengzi_ai') {
                        // v1.5.8: item.content æ˜¯å­—ä¸²ï¼Œéœ€ split
                        updateOrAddField(existingContent.fields, "ç¿’å¯«å­—", item.content.split(''));
                    } else if (dataType === 'lesson_text_ai') {
                        existingContent.mainText = item.content; 
                    } else if (dataType === 'terms_ai') {
                        updateOrAddField(existingContent.fields, "èªè©", item.content); 
                    } else if (dataType === 'patterns_ai') {
                        updateOrAddField(existingContent.fields, "å¥å‹ç·´ç¿’", item.content); 
                    }

                    const dataToSave = {
                        id: docId,
                        publisher: publisher,
                        subject: subject,
                        semester: item.semester,
                        grade: item.grade,
                        unit: item.lesson,
                        content: existingContent, 
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    return docRef.set(dataToSave)
                        .then(() => {
                            logBatch(`âœ… æˆåŠŸ (åˆä½µ): ${docId}`, 'success');
                            existingPaths.add(docId); 
                        })
                        .catch((err) => {
                            logBatch(`âŒ å¤±æ•— (åˆä½µ): ${docId} - ${err.message}`, 'error');
                        });
                }; 

                const promises = batch.map(processItem);
                
                await Promise.all(promises); 
                logBatch(`--- (æ‰¹æ¬¡ ${Math.floor(i / BATCH_SIZE) + 1} å®Œæˆ) ---`, 'info');
            }
            
            logBatch('ğŸ‰ğŸ‰ğŸ‰ å…¨éƒ¨è³‡æ–™å·²è™•ç†å®Œæˆï¼', 'success');
            showToast("âœ… æ‰¹æ¬¡è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼");
            
            currentDocCache = {}; 
            renderNavigator(currentPathParts.length); 
            dom.aiPreviewArea.classList.add('hidden'); // éš±è—é è¦½å€

        } catch (error) {
            console.error("æ‰¹æ¬¡ä¸Šå‚³å¤±æ•—:", error);
            logBatch(`âŒ ç™¼ç”Ÿåš´é‡éŒ¯èª¤: ${error.message}`, 'error');
            showToast("âŒ æ‰¹æ¬¡ä¸Šå‚³å¤±æ•—ï¼", "error");
        } finally {
            dom.batchUploadBtn.disabled = false;
            dom.confirmBatchUploadBtn.disabled = false;
            dom.confirmBatchUploadBtn.textContent = "ğŸš€ ç¢ºèªç„¡èª¤ï¼Œé–‹å§‹ä¸Šå‚³";
        }
    }


    // --- äº‹ä»¶ç¶å®š ---
    
    // ğŸ¨ v1.5.9 ä¿®æ­£ (éœ€æ±‚ 2)ï¼š
    // 1. openAdminModalWithReset: é–‹å•Ÿã€Œç©ºç™½ã€çš„ç®¡ç†å¾Œå°
    // 2. openAdminModal: åƒ…é–‹å•Ÿ Modalï¼Œä¸é‡ç½® (ç”¨æ–¼ Quick Edit)
    
    // (é–‹å•Ÿã€Œç©ºç™½ã€çš„å¾Œå°ï¼Œç”¨æ–¼ âš™ï¸ æŒ‰éˆ•)
    function openAdminModalWithReset() {
        dom.adminModal.classList.add("visible");
        dom.adminModal.classList.remove("hidden");
        loadAiSettingsStatus();
        
        // æ‰“é–‹é¢æ¿æ™‚ï¼Œé‡ç½®å–®å…ƒè¼¸å…¥æ¡†ç‚ºã€Œæ‰‹å‹•è¼¸å…¥ã€
        showAdminUnitInput(); // é è¨­ç‚ºæ‰‹å‹•è¼¸å…¥
        clearAdminFormFields(true); // æ¸…ç©ºæ¬„ä½ (ä¸¦æ¸…ç©ºä¸‹æ‹‰é¸å–®)
        updateAdminDocIdPreview(); // æ›´æ–°é è¦½
    }
    
    // (åƒ…é–‹å•Ÿ Modalï¼Œä¸é‡ç½®ï¼Œç”¨æ–¼ Quick Edit)
    function openAdminModal() {
        dom.adminModal.classList.add("visible");
        dom.adminModal.classList.remove("hidden");
        loadAiSettingsStatus();
        // ä¸é‡ç½®è¡¨å–®
    }
    

    document.addEventListener("DOMContentLoaded", () => {
        setTimeout(fetchExistingPaths, 100); 
        updateAdminControls(); // ğŸ¨ v1.5.9 (éœ€æ±‚ 2)ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹
        
        // ğŸ¨ v1.5.9 ä¿®æ­£ (éœ€æ±‚ 2)ï¼šä¿®æ”¹ç‚ºç™»å…¥(âš™ï¸) / ç™»å‡º(ğŸ”“) / é–‹å•Ÿè¨­å®š(âš™ï¸)
        dom.settingsBtn.addEventListener("click", () => {
            if (sessionStorage.getItem(ADMIN_AUTH_KEY) === 'true') {
                // å·²ç™»å…¥ -> é–‹å•Ÿè¨­å®šä»‹é¢ (ç©ºç™½)
                openAdminModalWithReset();
            } else {
                // å·²ç™»å‡º -> åŸ·è¡Œç™»å…¥
                const password = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
                if (password === ADMIN_PASSWORD) {
                    sessionStorage.setItem(ADMIN_AUTH_KEY, 'true'); // è¨˜ä½ç‹€æ…‹
                    updateAdminControls();
                    showToast("âœ… å·²ç™»å…¥ (Quick Edit å•Ÿç”¨)", "success");
                } else if (password) {
                    alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                }
            }
        });
        
        dom.logoutBtn.addEventListener("click", () => {
             // åŸ·è¡Œç™»å‡º
            sessionStorage.removeItem(ADMIN_AUTH_KEY);
            updateAdminControls();
            showToast("ğŸ”’ å·²ç™»å‡ºç®¡ç†æ¨¡å¼", "info");
        });
        
        document.getElementById("closeAdminBtn").addEventListener("click", () => {
            dom.adminModal.classList.remove("visible");
            dom.adminModal.classList.add("hidden");
        });
        
        // --- æ‰‹å‹•å„²å­˜ ---
        document.getElementById("loadDataBtn").addEventListener("click", handleLoadData);
        document.getElementById("saveDataBtn").addEventListener("click", handleSaveData);
        document.getElementById("fetchUnitsBtn").addEventListener("click", fetchUnitsForAdmin);
        document.getElementById("createNewUnitBtn").addEventListener("click", showAdminUnitInput);
        
        // ğŸ¨ v1.5.9 æ–°å¢ (éœ€æ±‚ 1)ï¼šç¶å®šåˆªé™¤æŒ‰éˆ•
        document.getElementById("deleteDocBtn").addEventListener("click", handleDeleteDocument);
        
        // ğŸ¨ v1.5.9 æ–°å¢ (éœ€æ±‚ 1)ï¼šç¶å®šæ¸…ç©ºæ¬„ä½æŒ‰éˆ• (äº‹ä»¶å§”æ´¾)
        document.getElementById("adminForm").addEventListener('click', (e) => {
            if (e.target.dataset.clearId) {
                const id = e.target.dataset.clearId;
                document.getElementById(`adminLabel${id}`).value = "";
                document.getElementById(`adminContent${id}`).value = "";
                showToast(`â„¹ï¸ æ¬„ä½ ${id} å·²æ¸…ç©º (å„²å­˜å¾Œç”Ÿæ•ˆ)`, "info");
            }
        });
        
        // --- (å‹•æ…‹é è¦½ Doc ID) ---
        adminForm.publisher.addEventListener("change", updateAdminDocIdPreview);
        adminForm.subject.addEventListener("change", updateAdminDocIdPreview);
        adminForm.semester.addEventListener("change", updateAdminDocIdPreview);
        adminForm.grade.addEventListener("change", updateAdminDocIdPreview);
        adminForm.unitId.addEventListener("input", updateAdminDocIdPreview);
        adminForm.unitSelector.addEventListener("change", updateAdminDocIdPreview);

        // --- æ‰¹æ¬¡è™•ç† ---
        dom.fileUploadInput.addEventListener("change", handleFileUpload);
        dom.batchUploadBtn.addEventListener("click", handleBatchUpload); // è§¸ç™¼åˆ†æ
        dom.confirmBatchUploadBtn.addEventListener("click", handleConfirmBatchUpload); 
        
        // AI è¨­å®šå„²å­˜
        dom_v1_5.saveAiSettingsBtn.addEventListener("click", saveAiSettings);
    });

</script>
</body>
</html>